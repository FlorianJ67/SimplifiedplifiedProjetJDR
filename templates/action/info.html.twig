{% extends 'base.html.twig' %}

{% block title %}info Action{% endblock %}

{% block header %}
    {{ include('header.html.twig') }}
{% endblock %}

{% block body %}
<h2>Action</h2>
<div id="resumePerso">
    <p>{{ action.personnage }}</p>
    {% if action.objet %}
        <p>{{ action.objet }}</p>
        <div>
            {% set damageWeap = action.objet.valeur|split('d') %}
            {% if damageWeap|length > 1  %}
                {% set damageWeap2 = damageWeap[1]|split('+') %}
                {% if damageWeap|length > 1 %}
                    <p id="resumeDmg">Calcule de Dégats: {{ damageWeap[0] }} dés {{ damageWeap2[0] }} + {{ damageWeap2[1] }}</p>
                {% else %} 
                    <p id="resumeDmg">Calcule de Dégats: {{ damageWeap[0] }} dés {{ damageWeap2[0] }} </p>
                {% endif %}
            {% else %}
                <p id="resumeDmg">Calcule de Dégats: 1 dés {{ damageWeap[0] }} </p>
            {% endif %}
            <button id="damageBtn" type="button" onclick="damageCalculator()">Lancé le jet de dégats</button>
            <div id="resultDamage" >
                
            </div>
        </div>
    {% endif %}
    <p>basé sur un lancé de dé {{ action.dice }}</p>
    {% set zero = true %}
    {% set ignoreCarac = false %}
    <p> Résultat:
    {% if action.competence %}
    <!-- Si une compétence a été selectionner -->
        {% for comp in action.personnage.competencePersos %}
            <!-- On vérifie si le personnage possède la compétence -->
            {% if comp.competence == action.competence %}
                {% for carac in comp.competence.competenceInflueCaracs|slice(0, 1) %}
                <!-- On cherche la caractéristique lié à la compétence -->
                    {% for caracPerso in action.personnage.caracteristiquePersos %}
                    <!-- On cherche la valeur de la caracteristique du personnage -->
                        {% if caracPerso.caracteristique == carac.caracteristique %}
                        <!-- On vérifie si le personnage a la caractérisitique lié a la compétence -->
                            {% if carac.valeurBonus|first == "x" or carac.valeurBonus|first == "*" %}
                            <!-- Si la valeur du bonus commence par "x" ou "*" on considère que c'est une multiplication -->
                                {{ action.diceScore + (caracPerso.valeur * carac.valeurBonus|slice(1)) }}
                                ({{ action.diceScore }}+({{ caracPerso.valeur }}x{{ carac.valeurBonus|slice(1) }}))
                                {% set ignoreCarac = true %}
                            {% elseif carac.valeurBonus|first == "+" %}
                            <!-- Si la valeur du bonus commence par un +  -->
                                {{ action.diceScore + (caracPerso.valeur + carac.valeurBonus|slice(1)) }}
                                ({{ action.diceScore }}+({{ caracPerso.valeur }}+{{ carac.valeurBonus|slice(1) }}))
                                {% set ignoreCarac = true %}
                            {% elseif carac.valeurBonus matches '/^\d+$/' %}
                            <!-- Si la valeur du bonus est composé uniquement de chiffre -->
                                {{ action.diceScore + (caracPerso.valeur + carac.valeurBonus) }}
                                ({{ action.diceScore }}+({{ caracPerso.valeur }}+{{ carac.valeurBonus }}))
                                {% set ignoreCarac = true %}                                
                            {% endif %}
                            {% set zero = false %}
                            <!-- Si la caractéristique apparait chez le personne on change la varible "zero" afin de passer l'étape du cas où le personnage n'a pas la compétence ni la caractéristique -->
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            {% endif %}
        {% endfor %}
    {% elseif action.caracteristique and ignoreCarac == false %}
    <!-- Si une caractéristique a été selectionner et que l'action n'a pas déjà été calculé via une compétence -->
        {% for carac in action.personnage.caracteristiquePersos %}
        <!-- On vérifie si le personnage possède la caractéristique -->
            {% if carac.caracteristique == action.caracteristique %}     
                {% if action.objet %}
                <!-- Si l'action possède un objet -->
                    {{ action.diceScore + carac.valeur + action.objet.valeur }}
                {% else %}
                <!-- Sinon -->
                    {{ action.diceScore + carac.valeur }}
                {% endif %}
                {% set zero = false %}
                <!-- Si la caractéristique apparait chez le personne on change la varible "zero" afin de passer l'étape du cas où le personnage n'a pas la compétence ni la caractéristique -->
            {% endif %}
        {% endfor %}
    {% endif %}
    {% if zero == true %}
        {% if action.objet %}
            {{  action.diceScore + action.objet.valeur }}
        {% else %}
            {{  action.diceScore }}
        {% endif %}
    {% endif %}
    {% if action.diceScore == 1 %}
    <!-- Si le lancé de dée fait le jet minimum -->
        Échec critique !
    {% elseif action.diceScore == action.dice %}
    <!-- Si le lancé de dée fait le jet maximum -->
        Coup Critique !
    {% endif %}
    </p>
</div>
{% endblock %}

{% block javascripts %}
<script>
    // On définie nos variables
    let calculDamageBtn = document.getElementById("damageBtn");
    let resultDamage = document.getElementById("resultDamage");
    let resumeDmg = document.getElementById("resumeDmg").textContent;
    resumeDmg = resumeDmg.replace('Calcule de Dégats: ','');

    function getRandomInt(max) {
        return Math.floor(Math.random() * max);
    }

    function damageCalculator() {
        resultDamage.innerHTML = "";
        let dmgFormula = resumeDmg.split(' dés ');
        if(dmgFormula.length > 1) {
            diceQte = Number(dmgFormula[0]);
            diceNbrAndBonus = dmgFormula[1].split(' + ');
            if(diceNbrAndBonus.length > 1) {
                diceNbr = Number(diceNbrAndBonus[0]);
                bonusDmg = Number(diceNbrAndBonus[1]);
            } else {
                diceNbr = Number(diceNbrAndBonus[0]);
            }
        } else {
            diceNbr = Number(dmgFormula[0]);
        }
        let diceScore = []
        if (diceQte && diceNbr) {
            for (let i = 0; i < diceQte; i++) {
                diceScore.push(getRandomInt(diceNbr));
            }
        } else {
            diceScore.push(getRandomInt(diceNbr));
        }
        let totalScore = 0;
        if (bonusDmg) {
            for (let i = 0; i < diceQte; i++) {
                totalScore += diceScore[i] +1;
            }
            totalScore += bonusDmg;
        } else {
            for (let i = 0; i < diceQte; i++) {
                totalScore += diceScore[i] +1;
            }
        }
        const textnode = document.createTextNode("Score: " + totalScore);
        let node = document.createElement("p");
        node.appendChild(textnode);
        resultDamage.appendChild(node);
        for (let i = 0; i < diceScore.length; i++) {
            let node = document.createElement("p");
            let textnode = document.createTextNode((i+1) + ".dé "+ diceNbr + ": " + (diceScore[i] + 1));
            node.appendChild(textnode);
            resultDamage.appendChild(node);
        }
        if (bonusDmg) {
            let node = document.createElement("p");
            let textnode = document.createTextNode("Bonus: +" + bonusDmg);
            node.appendChild(textnode);
            resultDamage.appendChild(node);
        }
    }
</script>
{% endblock %}

{% block footer %}
    {{ include('footer.html.twig') }} 
{% endblock %}