{% extends 'base.html.twig' %}

{% block title %}info Action{% endblock %}

{% block header %}
    {{ include('header.html.twig') }}
{% endblock %}

{% block body %}
<h2>Action</h2>
<div id="resumePerso">
    <p>{{ action.personnage }}</p>
    <p>{{ action.objet }}</p>
    {% set zero = true %}
    {% set ignoreCarac = false %}
    <p> Résultat:
    {% if action.competence %}
    <!-- Si une compétence a été selectionner -->
        {% for comp in action.personnage.competencePersos %}
            <!-- On vérifie si le personnage possède la compétence -->
            {% if comp.competence == action.competence %}
                {% for carac in comp.competence.competenceInflueCaracs|slice(0, 1) %}
                <!-- On cherche la caractéristique lié à la compétence -->
                    {% for caracPerso in action.personnage.caracteristiquePersos %}
                    <!-- On cherche la valeur de la caracteristique du personnage -->
                        {% if caracPerso.caracteristique == carac.caracteristique %}
                        <!-- On vérifie si le personnage a la caractérisitique lié a la compétence -->
                            {% if carac.valeurBonus|first == "x" or carac.valeurBonus|first == "*" %}
                            <!-- Si la valeur du bonus commence par "x" ou "*" on considère que c'est une multiplication -->
                                {% if action.objet %}
                                <!-- Si l'action possède un objet -->
                                    {{ action.diceScore + (caracPerso.valeur * carac.valeurBonus|slice(1)) + action.objet.valeur }}
                                    {% set ignoreCarac = true %}
                                {% else %}
                                <!-- Sinon -->
                                    {{ action.diceScore + (caracPerso.valeur * carac.valeurBonus|slice(1)) }}
                                    {% set ignoreCarac = true %}
                                {% endif %}
                            {% elseif carac.valeurBonus|first == "+" or carac.valeurBonus matches '/^\d+$/' %}
                            <!-- Si la valeur du bonus commence par un + ou est composé uniquement de chiffre -->
                                {% if action.objet %}
                                <!-- Si l'action possède un objet -->
                                    {{ action.diceScore + (caracPerso.valeur + carac.valeurBonus|slice(1)) + action.objet.valeur }}
                                    {% set ignoreCarac = true %}
                                {% else %}
                                <!-- Sinon -->
                                    {{ action.diceScore + (caracPerso.valeur + carac.valeurBonus|slice(1)) }}
                                    {% set ignoreCarac = true %}
                                {% endif %}
                            {% endif %}
                            {% set zero = false %}
                            <!-- Si la caractéristique apparait chez le personne on change la varible "zero" afin de passer l'étape du cas où le personnage n'a pas la compétence ni la caractéristique -->
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            {% endif %}
        {% endfor %}
    {% elseif action.caracteristique and ignoreCarac == false %}
    <!-- Si une caractéristique a été selectionner et que l'action n'a pas déjà été calculé via une compétence -->
        {% for carac in action.personnage.caracteristiquePersos %}
        <!-- On vérifie si le personnage possède la caractéristique -->
            {% if carac.caracteristique == action.caracteristique %}     
                {% if action.objet %}
                <!-- Si l'action possède un objet -->
                    {{ action.diceScore + carac.valeur + action.objet.valeur }}
                {% else %}
                <!-- Sinon -->
                    {{ action.diceScore + carac.valeur }}
                {% endif %}
                {% set zero = false %}
                <!-- Si la caractéristique apparait chez le personne on change la varible "zero" afin de passer l'étape du cas où le personnage n'a pas la compétence ni la caractéristique -->
            {% endif %}
        {% endfor %}
    {% endif %}
    {% if zero == true %}
        {% if action.objet %}
            {{  action.diceScore + action.objet.valeur }}
        {% else %}
            {{  action.diceScore }}
        {% endif %}
    {% endif %}
    {% if action.diceScore == 1 %}
    <!-- Si le lancé de dée fait le jet minimum -->
        Échec critique !
    {% elseif action.diceScore == action.dice %}
    <!-- Si le lancé de dée fait le jet maximum -->
        Coup Critique !
    {% endif %}
    </p>
</div>
{% endblock %}

{% block footer %}
    {{ include('footer.html.twig') }} 
{% endblock %}